<!-- GLB Viewer Template -->
<!-- 用于在 entry.ftl 中嵌入 GLB 模型查看器 -->

<style>
.glb-viewer-container {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    margin: 20px 0;
    background: #f8f9fa;
    height: 400px;
    position: relative;
    transition: all 0.3s ease;
}

.glb-viewer-container.drag-over {
    border-color: #007bff;
    background: #e3f2fd;
    transform: scale(1.02);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .glb-viewer-container {
        height: 300px;
    }
}

/* 深色主题支持 */
[data-bs-theme="dark"] .glb-viewer-container {
    background: #212529;
    border-color: #495057;
}

[data-bs-theme="dark"] .glb-viewer-container.drag-over {
    background: #1e3a5f;
    border-color: #0d6efd;
}
</style>

<div class="glb-viewer-container" id="glb-viewer-${viewerId}">
    <!-- 拖拽覆盖层 -->
    <div id="drop-overlay-${viewerId}" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 123, 255, 0.1);
        border: 3px dashed #007bff;
        border-radius: 8px;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        pointer-events: none;
    ">
        <div style="text-align: center; color: #007bff;">
            <i class="bi bi-cloud-upload" style="font-size: 48px;"></i>
            <h4>拖拽 GLB 文件到此处</h4>
            <p>支持 .glb 和 .gltf 格式</p>
        </div>
    </div>
</div>

<script type="module">
// 动态创建查看器实例
(async function() {
    // 等待 GLBViewer 加载完成
    while (typeof window.GLBViewer === 'undefined') {
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    try {
        const viewer = new window.GLBViewer('glb-viewer-${viewerId}', {
            width: 'auto',
            height: 'auto',
            backgroundColor: 0xe6f3ff,
            enableControls: true,
            enableGrid: true,
            enableAxes: false, <!-- 在文档中隐藏坐标轴 -->
            enableShadows: true,
            autoRotate: false,
            minDistance: 3,
            maxDistance: 30
        });
        
        // 如果有默认模型 URL，自动加载
        <#if modelUrl?? && modelUrl?has_content>
        try {
            await viewer.loadGLB('${root}/${modelUrl}', {
                position: [0, 0, 0],
                scale: ${scale!'[1, 1, 1]'}
            });
        } catch (error) {
            console.error('Failed to load default model:', error);
        }
        </#if>
        
        // 将实例存储到全局对象，方便调试
        window.glbViewers = window.glbViewers || {};
        window.glbViewers['${viewerId}'] = viewer;
        
        console.log('GLB Viewer ${viewerId} initialized successfully');
        
    } catch (error) {
        console.error('Failed to initialize GLB Viewer ${viewerId}:', error);
        document.getElementById('glb-viewer-${viewerId}').innerHTML = 
            '<div class="alert alert-danger m-3">无法初始化 3D 查看器: ' + error.message + '</div>';
    }
})();
</script>